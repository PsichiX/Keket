<!DOCTYPE HTML>
<html lang="en" class="ayu sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Asset Database - Keket - Asset Database on top of ECS</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Keket - Asset Database on top of ECS</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="asset-database"><a class="header" href="#asset-database">Asset Database</a></h1>
<p>Let's dive into central point of the library - asset database.</p>
<p><code>AssetDatabase</code> is a thin, higher level abstraction for underlying (public) ECS
storage where assets data live.</p>
<p>ECS as storage allowed to treat assets as rows in database tables, where single
asset can have multiple data columns associated with given asset. This opened up
a possibility for fast queries and lookups on multiple entities that pass given
requirements (set of components).</p>
<p>This is very important for systems which process and modify assets in specific
for them ways (in <code>Keket</code> those systems are asset fetch engines and asset
protocols - more about them later in the book).</p>
<p>We can use queries and lookups to process only assets that have given set of
requirements based on the data they store. For example when we load assets with
<code>FileAssetFetch</code>, we get not only asset data, but also meta data as <code>PathBuf</code> and
<code>Metadata</code> components, so if we want to for example scan database for all assets
that come from file system, we can just query them with <code>PathBuf</code> component and
use that fast query for asset statistics report.</p>
<pre><code class="language-rust ignore"><span class="boring">use keket::{
</span><span class="boring">    database::{path::AssetPath, AssetDatabase},
</span><span class="boring">    fetch::file::FileAssetFetch,
</span><span class="boring">    protocol::{bundle::BundleAssetProtocol, bytes::BytesAssetProtocol, text::TextAssetProtocol},
</span><span class="boring">};
</span><span class="boring">use serde::Deserialize;
</span><span class="boring">use serde_json::Value;
</span><span class="boring">use std::{error::Error, fs::Metadata, path::PathBuf};
</span><span class="boring">
</span><span class="boring">#[derive(Debug, Deserialize)]
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">struct Person {
</span><span class="boring">    age: u8,
</span><span class="boring">    home: PersonHome,
</span><span class="boring">    friends: Vec&lt;String&gt;,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">#[derive(Debug, Deserialize)]
</span><span class="boring">#[allow(dead_code)]
</span><span class="boring">struct PersonHome {
</span><span class="boring">    country: String,
</span><span class="boring">    address: String,
</span><span class="boring">}
</span><span class="boring">
</span><span class="boring">fn main() -&gt; Result&lt;(), Box&lt;dyn Error&gt;&gt; {
</span><span class="boring">    let mut database = AssetDatabase::default()
</span><span class="boring">        // Asset protocols tell how to deserialize bytes into assets.
</span><span class="boring">        .with_protocol(TextAssetProtocol)
</span><span class="boring">        .with_protocol(BytesAssetProtocol)
</span><span class="boring">        // Bundle protocol allows for easly making a protocol that takes
</span><span class="boring">        // bytes and returns bundle with optional dependencies.
</span><span class="boring">        .with_protocol(BundleAssetProtocol::new("json", |bytes: Vec&lt;u8&gt;| {
</span><span class="boring">            let asset = serde_json::from_slice::&lt;Value&gt;(&amp;bytes)?;
</span><span class="boring">            Ok((asset,).into())
</span><span class="boring">        }))
</span><span class="boring">        .with_protocol(BundleAssetProtocol::new("person", |bytes: Vec&lt;u8&gt;| {
</span><span class="boring">            let asset = serde_json::from_slice::&lt;Person&gt;(&amp;bytes)?;
</span><span class="boring">            Ok((asset,).into())
</span><span class="boring">        }))
</span><span class="boring">        // Asset fetch tells how to get bytes from specific source.
</span><span class="boring">        .with_fetch(FileAssetFetch::default().with_root("resources"));
</span><span class="boring">
</span><span class="boring">    // Ensure method either gives existing asset handle or creates new
</span><span class="boring">    // and loads asset if not existing yet in storage.
</span><span class="boring">    let lorem = database.ensure("text://lorem.txt")?;
</span><span class="boring">    // Accessing component(s) of asset entry.
</span><span class="boring">    // Assets can store multiple data associated to them, consider them meta data.
</span><span class="boring">    println!("Lorem Ipsum: {}", lorem.access::&lt;&amp;String&gt;(&amp;database));
</span><span class="boring">
</span><span class="boring">    let json = database.ensure("json://person.json")?;
</span><span class="boring">    println!("JSON: {:#}", json.access::&lt;&amp;Value&gt;(&amp;database));
</span><span class="boring">
</span><span class="boring">    let person = database.ensure("person://person.json")?;
</span><span class="boring">    println!("Person: {:#?}", person.access::&lt;&amp;Person&gt;(&amp;database));
</span><span class="boring">
</span><span class="boring">    let trash = database.ensure("bytes://trash.bin")?;
</span><span class="boring">    println!("Bytes: {:?}", trash.access::&lt;&amp;Vec&lt;u8&gt;&gt;(&amp;database));
</span><span class="boring">
</span>    // We can query storage for asset components to process assets, just like with ECS.
    for (asset_path, file_path, metadata) in database
        .storage
        .query::&lt;true, (&amp;AssetPath, &amp;PathBuf, &amp;Metadata)&gt;()
    {
        println!(
            "Asset: `{}` at location: {:?} has metadata: {:#?}",
            asset_path, file_path, metadata
        );
    }
<span class="boring">
</span><span class="boring">    Ok(())
</span><span class="boring">}</span></code></pre>
<p>Since storage is just an ECS, every asset entity always must store at least
<code>AssetPath</code> component to be considered valid asset - every component other than
asset path is considered asset data that is either usable for outside systems,
or for asset fetch engines and asset protocols as meta data for them in asset
resolution process.</p>
<blockquote>
<p>When an asset entity stores some components without asset path, then it is
never considered an actual asset, and rather an entity not important to asset
management - some systems might find it useful for them, but it is highly not
advised to put there anything other than assets.</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../introduction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../database/life_cycle.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../introduction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../database/life_cycle.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
